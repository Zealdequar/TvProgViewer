using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml.Linq;
using TVProgViewer.BusinessLogic.Updater;
using TVProgViewer.DataAccess.Adapters;
using TVProgViewer.Common;
using NLog;
using System.Diagnostics;
using System.Xml.XPath;
using System.IO;

namespace TVProgUpdater
{
    class Program
    {
        private static Logger _logger = LogManager.GetLogger("dbupdate");
        private static Dictionary<string, string> _dictChanCodeOld = new Dictionary<string, string>();
        private static Dictionary<string, string> _dictChanCodeNew = new Dictionary<string,string>();  
        static void Main(string[] args)
        {                  
            _logger.Info(" =========== Начало обновления ============ ");
            Stopwatch sw = Stopwatch.StartNew();
            List<WebResource> listWebResources = DataBasePart.GetWebResources();
            foreach (WebResource wr in listWebResources)
            {
                try
                {
                    _logger.Info("Обновление для ID='{0}'", wr.WebResourceID);
                    Stopwatch swLoc = Stopwatch.StartNew();
                    string fileName = wr.FileName;
                    WebPart.GetWebTVProgramm(wr.WrUri, ref fileName);
                    wr.FileName = fileName;
                    XDocument xDoc = new XDocument();
                    if (wr.SourceType == Enums.TypeProg.XMLTV)
                    {
                        xDoc = XDocument.Load(wr.FileName, LoadOptions.SetLineInfo);
                        xDoc = WebPart.ReformatXDoc(xDoc);
                        if (wr.WebResourceID == 1)
                            foreach (XElement xChan in xDoc.XPathSelectElements("tv/channel"))
                            {
                                string id = xChan.Attribute("id").Value;
                                _dictChanCodeOld[xChan.Element("display-name").Value] = id;
                            }
                        else if (wr.WebResourceID == 2)
                            foreach (XElement xChan in xDoc.XPathSelectElements("tv/channel"))
                            {
                                string id = xChan.Attribute("id").Value;
                                _dictChanCodeNew[xChan.Element("display-name").Value] = xChan.Attribute("id").Value;
                            }
                    }
                    else if (wr.SourceType == Enums.TypeProg.InterTV)
                    {
                        if (wr.WebResourceID == 3)
                            xDoc = ConverterProg.InterToXml(wr.FileName, _dictChanCodeOld);
                        else if (wr.WebResourceID == 4)
                            xDoc = ConverterProg.InterToXml(wr.FileName, _dictChanCodeNew);
                    }
                    wr.xmlDoc = xDoc.ToString();
                    _logger.Info("Каналы и тв-программа ID='{0}' подготовлены к запуску обработки в базе", wr.WebResourceID);
                    UpdaterAdapter.ExecWebResource(wr.WebResourceID, wr.xmlDoc);
                    if (wr.WebResourceID == 2)
                    {
                        _logger.Info("Обработка каналов и тв-программы ID='{0}' завершена. Начало загрузки пиктограмм.", wr.WebResourceID);
                        Stopwatch swPict = Stopwatch.StartNew();
                        foreach (XElement xChan in xDoc.XPathSelectElements("tv/channel"))
                        {
                            string id = xChan.Attribute("id").Value;
                            if (xChan.Element("icon") != null)
                            {
                                string src = xChan.Element("icon").Attribute("src").Value;
                                if (!string.IsNullOrWhiteSpace(src))
                                {
                                    Tuple<byte[], byte[]> channelIcons = WebPart.GetAndSaveIcon(id, src);
                                    UpdaterAdapter.UpdateIcon(Convert.ToInt32(id), src, id + ".gif", "image/gif", "gzip", 
                                        channelIcons.Item1, channelIcons.Item2);
                                }
                            }
                        }
                        swPict.Stop();
                        _logger.Info("Загрузка пиктограмм завершена. Потребовалось {0} сек.",  swPict.ElapsedMilliseconds/1000.0);
                    }
                    
                    swLoc.Stop();
                    _logger.Info("Обновление для ID='{0}' успешно завершено. Затрачено '{1}' сек.", wr.WebResourceID, swLoc.ElapsedMilliseconds/1000.0);
                }
                catch (Exception ex)
                {
                    _logger.Error("Обновление тв-программы прошло неуспешно: ErrMessage='{0}', StackTrace='{1}'", ex.Message, ex.StackTrace);
                }
            }
            sw.Stop();
            _logger.Info(" ========== Обновление завершено ========== (Затрачено: {0} сек.)", sw.ElapsedMilliseconds/1000.0);
        }


    }
}
