using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using TVProgViewer.BusinessLogic.Updater;

namespace TVProgViewer.DataAccess.Adapters
{
    public class UpdaterAdapter : AdapterBase
    {
        private static Func<DbDataReader, WebResource> getWebResourcesFunc = r =>
        {
            return new WebResource()
            {
                WebResourceID = r.GetIntOrDefault("WebResourceID"),
                SourceType = (r.GetStringOrDefault("TypeName") == "Формат XMLTV") ? TypeProg.XMLTV : TypeProg.InterTV,
                FileName = r.GetStringOrDefault("FileName"),
                ResourceName = r.GetStringOrDefault("ResourceName"),
                WrUri = new Uri(r.GetStringOrDefault("ResourceUrl"))
            };
        };
        
        public static List<WebResource> GetWebResource()
        {
            return DataAccess.ExecReaderCommand<WebResource>(
                GetTvProgMainConnection(), "spGetWebResources", (DbParameter) null, getWebResourcesFunc);
        }

        public static void ExecWebResource(int wrid, string xmlDoc)
        {
            List<SqlParameter> pars = new List<SqlParameter>
            {
                new SqlParameter("@WRID", SqlDbType.Int) {Value = wrid},
                new SqlParameter("@ChanAndProg", SqlDbType.Xml) {Value = xmlDoc}
            };
            DataAccess.ExecCommand(GetTvProgMainConnection(), "spUpdateXmlChansAndProgs",  pars.Cast<DbParameter>().ToList<DbParameter>());
        }
    }
}
